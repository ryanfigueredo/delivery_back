// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrderStatus {
  pending
  printed
  finished
  out_for_delivery
}

// Modelo Tenant (Multi-tenant)
model Tenant {
  id          String   @id @default(uuid())
  name        String   // Nome do restaurante (ex: "Tamboril Burguer")
  slug        String   @unique // Identificador único (ex: "tamboril-burguer")
  api_key     String   @unique // API key única para cada tenant
  whatsapp_phone String? // Telefone do WhatsApp do bot (formato: 5521999999999)
  logo_url    String?  // URL da logo no S3
  is_active   Boolean  @default(true)
  
  // Credenciais Meta Cloud API (WhatsApp Business)
  meta_phone_number_id String? // Phone Number ID da Meta
  meta_access_token    String? // Access Token da Meta (criptografado)
  meta_verify_token    String? // Verify Token para webhook
  meta_business_account_id String? // Business Account ID
  
  // Status e configuração do bot
  bot_configured       Boolean  @default(false) // Se o bot está configurado
  bot_last_heartbeat   DateTime? // Última atividade do bot
  
  // Plano e limites
  plan_type            String   @default("basic") // basic, complete, premium
  plan_message_limit   Int      @default(1000) // Limite de mensagens do plano
  
  // Assinatura e pagamento
  subscription_payment_date DateTime? // Data do último pagamento
  subscription_expires_at   DateTime? // Data de vencimento da assinatura
  asaas_subscription_id     String?   // ID da assinatura no Asaas
  asaas_customer_id         String?   // ID do cliente no Asaas
  subscription_status       String?   @default("active") // active, expired, cancelled, pending
  
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relações
  orders      Order[]
  users       User[]
  message_usage MessageUsage[]

  @@map("tenants")
}

model Order {
  id            String      @id @default(uuid())
  tenant_id     String      // ID do tenant (restaurante)
  customer_name String
  customer_phone String
  items         Json        // JSONB para produtos e quantidades
  total_price   Decimal     @db.Decimal(10, 2)
  status        OrderStatus @default(pending)
  payment_method String?    // Método de pagamento (Dinheiro, PIX, Cartão, Crédito DMTN)
  created_at    DateTime    @default(now())
  order_number  Int?        // Número sequencial do pedido por telefone (001, 002, 003...)
  daily_sequence Int?       // Número sequencial do dia (1, 2, 3...)
  display_id    String?     // ID formatado como #1, #2, #3 (sequência diária)
  customer_total_orders Int? // Total de pedidos que este cliente já fez (para promoções)
  order_type    String?     // Tipo de pedido: 'restaurante' ou 'delivery'
  estimated_time Int?       // Tempo estimado em minutos
  delivery_address String?  // Endereço de entrega (apenas para delivery)
  print_requested_at DateTime? // Quando o dashboard web solicitou impressão (app-admin imprime e limpa)

  // Relação
  tenant        Tenant      @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@index([tenant_id, created_at])
  @@map("orders")
}

model User {
  id        String   @id @default(uuid())
  tenant_id String?  // ID do tenant (null = super admin que pode acessar todos)
  username  String
  password  String   // Hash da senha (bcrypt)
  name      String
  role      String   @default("admin") // admin, manager, etc
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relação
  tenant    Tenant?  @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, username]) // Username único por tenant
  @@index([tenant_id])
  @@map("users")
}

// Controle de uso de mensagens WhatsApp
model MessageUsage {
  id          String   @id @default(uuid())
  tenant_id   String
  month       Int      // 1-12
  year        Int      // 2026
  messages_sent Int    @default(0)
  conversations_started Int @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  @@unique([tenant_id, month, year])
  @@index([tenant_id])
  @@index([tenant_id, year, month])
  @@map("message_usage")
}
