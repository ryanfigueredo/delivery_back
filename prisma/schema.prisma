// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrderStatus {
  pending
  printed
  finished
  out_for_delivery
}

// Modelo Tenant (Multi-tenant)
model Tenant {
  id          String   @id @default(uuid())
  name        String   // Nome do restaurante (ex: "Tamboril Burguer")
  slug        String   @unique // Identificador único (ex: "tamboril-burguer")
  api_key     String   @unique // API key única para cada tenant
  whatsapp_phone String? // Telefone do WhatsApp do bot
  logo_url    String?  // URL da logo no S3
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relações
  orders      Order[]
  users       User[]

  @@map("tenants")
}

model Order {
  id            String      @id @default(uuid())
  tenant_id     String      // ID do tenant (restaurante)
  customer_name String
  customer_phone String
  items         Json        // JSONB para produtos e quantidades
  total_price   Decimal     @db.Decimal(10, 2)
  status        OrderStatus @default(pending)
  payment_method String?    // Método de pagamento (Dinheiro, PIX, Cartão, Crédito DMTN)
  created_at    DateTime    @default(now())
  order_number  Int?        // Número sequencial do pedido por telefone (001, 002, 003...)
  daily_sequence Int?       // Número sequencial do dia (1, 2, 3...)
  display_id    String?     // ID formatado como #1, #2, #3 (sequência diária)
  customer_total_orders Int? // Total de pedidos que este cliente já fez (para promoções)
  order_type    String?     // Tipo de pedido: 'restaurante' ou 'delivery'
  estimated_time Int?       // Tempo estimado em minutos
  delivery_address String?  // Endereço de entrega (apenas para delivery)
  print_requested_at DateTime? // Quando o dashboard web solicitou impressão (app-admin imprime e limpa)

  // Relação
  tenant        Tenant      @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@index([tenant_id, created_at])
  @@map("orders")
}

model User {
  id        String   @id @default(uuid())
  tenant_id String?  // ID do tenant (null = super admin que pode acessar todos)
  username  String
  password  String   // Hash da senha (bcrypt)
  name      String
  role      String   @default("admin") // admin, manager, etc
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relação
  tenant    Tenant?  @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, username]) // Username único por tenant
  @@index([tenant_id])
  @@map("users")
}
